AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Grafana EC2 instance with CloudWatch integration - REVISED with proper network binding

Parameters:
  InstanceType:
    Type: String
    Default: t3.small
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    Description: EC2 instance type
  
  KeyPairName:
    Type: String
    Description: EC2 Key Pair for SSH access (leave empty to use SSM only)
    Default: ''
  
  AllowedSSHCIDR:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR block allowed to SSH
    AllowedPattern: '^(\d{1,3}\.){3}\d{1,3}/\d{1,2}$'
  
  GrafanaAdminPassword:
    Type: String
    NoEcho: true
    Default: admin123!@#
    MinLength: 8
    Description: Grafana admin password
  
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID where Grafana will be deployed
  
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnet ID for Grafana instance

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Resources:
  # ============================================================================
  # IAM Role for EC2 Instance
  # ============================================================================
  GrafanaInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: GrafanaCloudWatchAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:*
                  - logs:*
                  - ec2:DescribeRegions
                  - ec2:DescribeTags
                  - ec2:DescribeInstances
                  - tag:GetResources
                Resource: '*'

  GrafanaInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref GrafanaInstanceRole

  # ============================================================================
  # Security Group
  # ============================================================================
  GrafanaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Grafana instance
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0
          Description: Grafana web interface
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHCIDR
          Description: SSH access
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-grafana-sg'

  # ============================================================================
  # EC2 Instance
  # ============================================================================
  GrafanaInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref GrafanaInstanceProfile
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SubnetId: !Ref SubnetId
      SecurityGroupIds:
        - !Ref GrafanaSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 20
            VolumeType: gp3
            DeleteOnTermination: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-grafana'
        - Key: Service
          Value: Grafana
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -x
          exec > >(tee /var/log/user-data.log) 2>&1
          
          echo "=========================================="
          echo "Grafana Installation Started: $(date)"
          echo "=========================================="
          
          # Update system
          dnf update -y
          dnf install -y wget curl jq
          
          # ====================================================================
          # Install Grafana
          # ====================================================================
          echo "Installing Grafana..."
          
          # Add Grafana repository
          cat > /etc/yum.repos.d/grafana.repo <<'REPO'
          [grafana]
          name=grafana
          baseurl=https://rpm.grafana.com
          repo_gpgcheck=1
          enabled=1
          gpgcheck=1
          gpgkey=https://rpm.grafana.com/gpg.key
          sslverify=1
          sslcacert=/etc/pki/tls/certs/ca-bundle.crt
          REPO
          
          # Install Grafana
          dnf install -y grafana
          
          # ====================================================================
          # Configure Grafana - CRITICAL: Bind to 0.0.0.0
          # ====================================================================
          echo "Configuring Grafana..."
          
          # Backup original config
          cp /etc/grafana/grafana.ini /etc/grafana/grafana.ini.backup
          
          # Create new config with explicit settings
          cat > /etc/grafana/grafana.ini <<'GRAFANA_CONFIG'
          ##################### Grafana Configuration #####################
          
          [paths]
          data = /var/lib/grafana
          logs = /var/log/grafana
          plugins = /var/lib/grafana/plugins
          provisioning = /etc/grafana/provisioning
          
          [server]
          # CRITICAL: Bind to all interfaces (0.0.0.0), not localhost
          http_addr = 0.0.0.0
          http_port = 3000
          domain = localhost
          root_url = http://localhost:3000
          
          [security]
          admin_user = admin
          admin_password = ${GrafanaAdminPassword}
          
          [auth.anonymous]
          enabled = false
          
          [log]
          mode = console file
          level = info
          
          [log.console]
          level = info
          
          [log.file]
          level = info
          GRAFANA_CONFIG
          
          # Set ownership
          chown grafana:grafana /etc/grafana/grafana.ini
          chmod 640 /etc/grafana/grafana.ini
          
          # ====================================================================
          # Create CloudWatch Datasource
          # ====================================================================
          echo "Creating CloudWatch datasource..."
          
          mkdir -p /etc/grafana/provisioning/datasources
          
          cat > /etc/grafana/provisioning/datasources/cloudwatch.yaml <<'DATASOURCE'
          apiVersion: 1
          
          datasources:
            - name: CloudWatch-Metrics
              type: cloudwatch
              access: proxy
              jsonData:
                authType: default
                defaultRegion: ${AWS::Region}
              isDefault: true
              editable: true
            
            - name: CloudWatch-Logs
              type: cloudwatch
              access: proxy
              jsonData:
                authType: default
                defaultRegion: ${AWS::Region}
                logGroups:
                  - /ecs/ecs-iot-consumer
              editable: true
          DATASOURCE
          
          chown -R grafana:grafana /etc/grafana/provisioning
          
          # ====================================================================
          # Create Dashboard
          # ====================================================================
          mkdir -p /etc/grafana/provisioning/dashboards
          mkdir -p /var/lib/grafana/dashboards
          
          cat > /etc/grafana/provisioning/dashboards/default.yaml <<'DASHPROV'
          apiVersion: 1
          
          providers:
            - name: 'Default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              allowUiUpdates: true
              options:
                path: /var/lib/grafana/dashboards
          DASHPROV
          
          # Comprehensive dashboard with all drone metrics
          cat > /var/lib/grafana/dashboards/drone-telemetry.json <<'DASHBOARD'
          {
            "title": "Drone Telemetry Dashboard",
            "uid": "drone-telemetry",
            "version": 2,
            "editable": true,
            "timezone": "browser",
            "refresh": "5s",
            "time": {
              "from": "now-15m",
              "to": "now"
            },
            "panels": [
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Metrics"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisLabel": "Messages/min",
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "lineWidth": 2,
                      "showPoints": "auto"
                    },
                    "unit": "short"
                  }
                },
                "gridPos": {"h": 6, "w": 8, "x": 0, "y": 0},
                "id": 1,
                "options": {
                  "legend": {"displayMode": "list", "placement": "bottom"}
                },
                "targets": [
                  {
                    "dimensions": {},
                    "metricName": "MessageCount",
                    "namespace": "DronePipeline",
                    "period": "60",
                    "refId": "A",
                    "region": "default",
                    "statistic": "Sum"
                  }
                ],
                "title": "Message Count (All Types)",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Metrics"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisLabel": "Altitude (m)",
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "lineWidth": 2
                    },
                    "unit": "lengthm"
                  }
                },
                "gridPos": {"h": 6, "w": 8, "x": 8, "y": 0},
                "id": 2,
                "targets": [
                  {
                    "dimensions": {},
                    "metricName": "AltitudeMSL",
                    "namespace": "DronePipeline",
                    "period": "",
                    "refId": "A",
                    "region": "default",
                    "statistic": "Average"
                  }
                ],
                "title": "Altitude MSL",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Metrics"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "thresholds"},
                    "max": 100,
                    "min": 0,
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "red", "value": 0},
                        {"color": "yellow", "value": 20},
                        {"color": "green", "value": 50}
                      ]
                    },
                    "unit": "percent"
                  }
                },
                "gridPos": {"h": 6, "w": 8, "x": 16, "y": 0},
                "id": 3,
                "options": {
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "showThresholdLabels": false,
                  "showThresholdMarkers": true
                },
                "targets": [
                  {
                    "dimensions": {},
                    "metricName": "BatteryPercent",
                    "namespace": "DronePipeline",
                    "period": "",
                    "refId": "A",
                    "region": "default",
                    "statistic": "Average"
                  }
                ],
                "title": "Battery Level",
                "type": "gauge"
              },
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Metrics"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisLabel": "Speed (m/s)",
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "lineWidth": 2
                    },
                    "unit": "velocityms"
                  }
                },
                "gridPos": {"h": 6, "w": 12, "x": 0, "y": 6},
                "id": 5,
                "targets": [
                  {
                    "dimensions": {},
                    "metricName": "GroundSpeed",
                    "namespace": "DronePipeline",
                    "period": "",
                    "refId": "A",
                    "region": "default",
                    "statistic": "Average"
                  }
                ],
                "title": "Ground Speed",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Metrics"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {"mode": "palette-classic"},
                    "custom": {
                      "axisLabel": "Satellites",
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "lineWidth": 2
                    },
                    "unit": "short"
                  }
                },
                "gridPos": {"h": 6, "w": 12, "x": 12, "y": 6},
                "id": 6,
                "targets": [
                  {
                    "dimensions": {},
                    "metricName": "GPSSatellites",
                    "namespace": "DronePipeline",
                    "period": "",
                    "refId": "A",
                    "region": "default",
                    "statistic": "Average"
                  }
                ],
                "title": "GPS Satellites",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "cloudwatch",
                  "uid": "CloudWatch-Logs"
                },
                "gridPos": {"h": 10, "w": 24, "x": 0, "y": 12},
                "id": 4,
                "options": {
                  "dedupStrategy": "none",
                  "enableLogDetails": true,
                  "prettifyLogMessage": true,
                  "showCommonLabels": false,
                  "showLabels": false,
                  "showTime": true,
                  "sortOrder": "Descending",
                  "wrapLogMessage": true
                },
                "targets": [
                  {
                    "expression": "fields @timestamp, @message | filter @message like /Parsed telemetry/ or @message like /msg_type/ | sort @timestamp desc | limit 50",
                    "logGroupNames": ["/ecs/ecs-iot-consumer"],
                    "queryMode": "Logs",
                    "refId": "A",
                    "region": "default"
                  }
                ],
                "title": "Recent Telemetry Messages (All Types)",
                "type": "logs"
              }
            ]
          }
          DASHBOARD
          
          chown -R grafana:grafana /var/lib/grafana/dashboards
          
          # ====================================================================
          # Start Grafana
          # ====================================================================
          echo "Starting Grafana..."
          
          systemctl daemon-reload
          systemctl enable grafana-server
          systemctl start grafana-server
          
          # Wait for Grafana to start
          sleep 10
          
          # ====================================================================
          # Verify Configuration
          # ====================================================================
          echo "=========================================="
          echo "Grafana Installation Complete: $(date)"
          echo "=========================================="
          
          # Get public IP
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
          
          echo ""
          echo "Grafana Status:"
          systemctl status grafana-server --no-pager || true
          
          echo ""
          echo "Listening on:"
          ss -tlnp | grep 3000 || echo "WARNING: Nothing listening on port 3000!"
          
          echo ""
          echo "Grafana URL: http://$PUBLIC_IP:3000"
          echo "Username: admin"
          echo "Password: ${GrafanaAdminPassword}"
          echo ""
          echo "Dashboard Information:"
          echo "  The 'Drone Telemetry Dashboard' includes panels for:"
          echo "    - Message Count (shows ALL message types - ATTITUDE, GPS, etc.)"
          echo "    - Altitude MSL (shows when GLOBAL_POSITION_INT messages arrive)"
          echo "    - Battery Level (shows when SYS_STATUS messages arrive)"
          echo "    - Ground Speed (shows when VFR_HUD messages arrive)"
          echo "    - GPS Satellites (shows when GPS_RAW_INT messages arrive)"
          echo "    - Recent Telemetry Logs (shows all parsed messages)"
          echo ""
          echo "  Note: Panels will show 'No data' until the corresponding"
          echo "  MAVLink message types are received from your drone."
          echo "  The Message Count and Logs panels will show data immediately"
          echo "  for any message type."
          echo ""
          
          # Save to file
          cat > /root/grafana-info.txt <<INFO
          Grafana Access Information
          ==========================
          
          URL: http://$PUBLIC_IP:3000
          Username: admin
          Password: ${GrafanaAdminPassword}
          
          Installation Date: $(date)
          Region: ${AWS::Region}
          
          Logs:
            User Data: /var/log/user-data.log
            Grafana: /var/log/grafana/grafana.log
            Service: journalctl -u grafana-server -f
          
          Config:
            Main: /etc/grafana/grafana.ini
            Datasources: /etc/grafana/provisioning/datasources/
            Dashboards: /var/lib/grafana/dashboards/
          
          Commands:
            Status: systemctl status grafana-server
            Restart: systemctl restart grafana-server
            Logs: journalctl -u grafana-server -f
            Listening: ss -tlnp | grep 3000
          INFO
          
          echo "=========================================="
          echo "Installation complete! Check /root/grafana-info.txt"
          echo "=========================================="

Outputs:
  GrafanaURL:
    Description: Grafana web interface URL
    Value: !Sub 'http://${GrafanaInstance.PublicIp}:3000'
  
  GrafanaPublicIP:
    Description: Grafana instance public IP
    Value: !GetAtt GrafanaInstance.PublicIp
    Export:
      Name: !Sub '${AWS::StackName}-PublicIP'
  
  GrafanaInstanceId:
    Description: Grafana EC2 instance ID
    Value: !Ref GrafanaInstance
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'
  
  DefaultUsername:
    Description: Grafana default username
    Value: admin
  
  SSMSessionCommand:
    Description: Connect via SSM Session Manager
    Value: !Sub 'aws ssm start-session --target ${GrafanaInstance} --region ${AWS::Region}'
  
  SecurityGroupId:
    Description: Security group ID
    Value: !Ref GrafanaSecurityGroup
  
  DiagnosticCommands:
    Description: Diagnostic commands to run
    Value: !Sub |
      # Check Grafana status
      aws ssm start-session --target ${GrafanaInstance}
      sudo systemctl status grafana-server
      sudo ss -tlnp | grep 3000
      sudo journalctl -u grafana-server -n 50